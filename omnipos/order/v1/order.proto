syntax = "proto3";

package omnipos.order.v1;

import "omnipos/auth/v1/auth_options.proto";
import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "validate/validate.proto";

option go_package = "github.com/fekuna/omnipos-proto/gen/go/omnipos/order/v1;omniposorderv1";

service OrderService {
  // Create a new order
  rpc CreateOrder(CreateOrderRequest) returns (CreateOrderResponse) {
    option (google.api.http) = {
      post: "/v1/orders"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Create Order"
      description: "Create a new order with items"
      tags: "Order"
    };
  }

  // Get order details
  rpc GetOrder(GetOrderRequest) returns (GetOrderResponse) {
    option (google.api.http) = {get: "/v1/orders/{id}"};
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Order"
      description: "Get details of a specific order"
      tags: "Order"
    };
  }

  // List orders
  rpc ListOrders(ListOrdersRequest) returns (ListOrdersResponse) {
    option (google.api.http) = {get: "/v1/orders"};
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List Orders"
      description: "List orders with usage filtering"
      tags: "Order"
    };
  }

  // Get dashboard statistics
  rpc GetDashboardStats(GetDashboardStatsRequest) returns (GetDashboardStatsResponse) {
    option (google.api.http) = {get: "/v1/dashboard/stats"};
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get Dashboard Stats"
      description: "Get aggregated metrics for the dashboard"
      tags: "Order"
    };
  }
}

// Enums

enum OrderStatus {
  ORDER_STATUS_UNSPECIFIED = 0;
  ORDER_STATUS_PENDING = 1;
  ORDER_STATUS_PAID = 2;
  ORDER_STATUS_CANCELLED = 3;
  ORDER_STATUS_REFUNDED = 4;
}

enum PaymentMethod {
  PAYMENT_METHOD_UNSPECIFIED = 0;
  PAYMENT_METHOD_CASH = 1;
  PAYMENT_METHOD_QRIS = 2;
  PAYMENT_METHOD_DEBIT = 3;
  PAYMENT_METHOD_CREDIT = 4;
}

// Messages

message OrderItem {
  string id = 1;
  string product_id = 2;
  string product_name = 3;
  string variant_id = 4; // Optional
  string variant_name = 5; // Optional
  double quantity = 6;
  double unit_price = 7;
  double total_price = 8;
  string notes = 9;
}

message Order {
  string id = 1;
  string merchant_id = 2;
  string store_id = 3;
  string customer_id = 4; // Optional
  string cashier_id = 5; // User ID of the cashier

  string order_number = 6; // Human readable ID
  OrderStatus status = 7;
  PaymentMethod payment_method = 8;

  double subtotal = 9;
  double tax_amount = 10;
  double discount_amount = 11;
  double total_amount = 12;

  double paid_amount = 13;
  double change_amount = 14;

  repeated OrderItem items = 15;

  google.protobuf.Timestamp created_at = 16;
  google.protobuf.Timestamp updated_at = 17;
}

// Requests & Responses

message CreateOrderItemInput {
  string product_id = 1 [(validate.rules).string.uuid = true];
  string variant_id = 2; // Optional
  double quantity = 3 [(validate.rules).double.gt = 0];
  double unit_price = 4 [(validate.rules).double.gte = 0]; // Sent from frontend to lock price, or validate backend? backend should validate.
  string notes = 5;
}

message CreateOrderRequest {
  string store_id = 1; // Optional, defaults to merchant's default store or cashier's store
  string customer_id = 2; // Optional

  PaymentMethod payment_method = 3 [(validate.rules).enum = {
    defined_only: true
    not_in: [0]
  }];

  repeated CreateOrderItemInput items = 4 [(validate.rules).repeated.min_items = 1];

  double paid_amount = 5 [(validate.rules).double.gte = 0]; // Amount tendered by customer
}

message CreateOrderResponse {
  Order order = 1;
}

message GetOrderRequest {
  string id = 1 [(validate.rules).string.uuid = true];
}

message GetOrderResponse {
  Order order = 1;
}

message ListOrdersRequest {
  int32 page = 1 [(validate.rules).int32.gte = 1];
  int32 page_size = 2 [(validate.rules).int32 = {
    gte: 1
    lte: 100
  }];

  string store_id = 3;
  string customer_id = 4;
  OrderStatus status = 5;

  google.protobuf.Timestamp start_date = 6;
  google.protobuf.Timestamp end_date = 7;
}

message ListOrdersResponse {
  repeated Order orders = 1;
  int32 total = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message GetDashboardStatsRequest {
  google.protobuf.Timestamp start_date = 1;
  google.protobuf.Timestamp end_date = 2;
}

message DailySales {
  string date = 1;
  double total = 2;
}

message TopProductStat {
  string product_name = 1;
  int32 sales_count = 2;
  double revenue = 3;
}

message GetDashboardStatsResponse {
  double total_revenue = 1;
  int32 total_orders = 2;
  int32 total_items_sold = 3;

  double revenue_trend_percent = 4;
  double orders_trend_percent = 5;

  repeated DailySales sales_chart = 6;
  repeated TopProductStat top_products = 7;
  repeated Order recent_transactions = 8;
}
